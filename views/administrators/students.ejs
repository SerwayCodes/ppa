<!DOCTYPE html>
<html lang="en">
  <%- include('../include/head' ); -%>

  <body>
    <div class="main-wrapper">
      <%- include('../include/pageheader' ); -%> <%-
      include('../include/admin_sidebar' ); -%>
      <div class="page-wrapper">
        <div class="content container-fluid">
          <div class="page-header">
            <div class="row align-items-center">
              <div class="col">
                <h3 class="page-title">Students</h3>
                <ul class="breadcrumb">
                  <li class="breadcrumb-item"><a href="index">Students</a></li>
                  <li class="breadcrumb-item active">Students List</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="card card-table">
              <div class="row">
                
                <div class="col-lg-4 col-sm-6 pt-3">
                  <select
                    id="selectedClass"
                    class="form-select"
                    name="selectedClass"
                    required
                  >
                    <option value="">Filter By Class</option>
                    <option value="1">Form 1</option>
                    <option value="2">Form 2</option>
                    <option value="3">Form 3</option>
                    <option value="4">Form 4</option>
                  </select>
                </div>
                <div class="col-lg-4 col-sm-6 pt-3">
                  <button id="apply" class="btn btn-outline-primary">
                    Apply Filters
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table
                    id="student-table"
                    class="table table-hover table-center mb-0 datatable"
                  >
                    <thead>
                      <tr>
                        <th>Student ID</th>
                        <th>First Name</th>
                        <th>Surname</th>
                        <th>Class</th>
                        <th>fees Balance</th>
                        <th class="text-right">Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% students.forEach(function(student) { %>
                      <tr>
                        <td><%= student.student_id %></td>
                        <td><%= student.first_name %></td>
                        <td><%= student.last_name %></td>
                        <td><%= student.form_level %></td>
                        <td class="text-center"><%= student.fees_balance %></td>
                        <td>
                          <button
                            class="btn btn-primary"
                            onclick="getStudentDetails('<%= student.student_id %>')"
                          >
                            View
                          </button>
                        </td>
                      </tr>
                      <% }); %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
        <%- include('../include/footer' ); -%>
      </div>
    </div>

    <%- include('../include/scripts' ); -%>
    <script>
      $(document).ready(function () {
        // Function to fetch and display student data
        function fetchStudentData(selectedClass) {
          if (user_role === "Admin") {
            $.ajax({
              url: "studentsfetch", // Your route for fetching student data
              method: "GET",
              data: {
                selectedClass: selectedClass,
              },
              success: function (response) {
                // Clear existing table rows
                $("#student-table tbody").empty();

                // Iterate through the fetched data and append rows to the table
                response.students.forEach(function (student) {
                  $("#student-table tbody").append(
                    `<tr>
                                      <td>${student.student_id}</td>
                                      <td>${student.first_name}</td>
                                      <td>${student.last_name}</td>
                                      <td>${student.allocated_program}</td>
                                      <td>${student.fees_balance}</td>
                                      <td>
                          <button class="btn btn-primary" onclick="getStudentDetails('${student.student_id}')">View</button>
                        </td>
                                  </tr>`
                  );
                });
              },
              error: function (xhr, status, error) {
                console.error("Error fetching student data:", error);
              },
            });
          }
        }

        // Event handler for the "Apply Filters" button click
        $("#apply").click(function () {
          const selectedClass = $("#selectedClass").val();
          // Call the fetchStudentData function with the selected session and class
          fetchStudentData(selectedClass);
        });

        fetchStudentData(""); // Change to your default values *
      });
    </script>
    <script>
     function getStudentDetails(studentId) {
  const encodedStudentId = encodeURIComponent(studentId);
  fetch(`view_student/${encodedStudentId}`)
    .then((response) => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json(); // Assuming the server responds with JSON data
    })
    .then((data) => {
      try {
        // Stringify the data and encode it as a URI component
        const encodedData = encodeURIComponent(JSON.stringify(data));
        // Redirect to another page and pass the data as a query parameter
        window.location.href = `student_profile?studentId=${encodedStudentId}&data=${encodedData}`;
      } catch (error) {
        console.error("Error while processing data:", error);
      }
    })
    .catch((error) => {
      console.error("Error:", error);
    });
}

    
    </script>
  </body>
</html>
